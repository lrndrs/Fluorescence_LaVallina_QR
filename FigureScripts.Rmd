---
title: "R Markdown Figure code"
author: "Laura Endres"
date: "2023-10-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

# Loading Libraries
library(ggplot2)
library(lubridate)
library(tidyverse)
library(ggpubr)
library(tidypaleo)
library(tidyr)
library(dplyr)
library(cowplot)
library(latex2exp)
library(scico)
library(zoo)
library(plotly)
library(stringr)
library(eemR)
library(patchwork)
library(knitr)
library(staRdom)
library(forcats)
library(factoextra)
library(tinytex)
library(readxl)

#Loading Data
aps.master <- readRDS(file="Data/APSmaster.rds")
aps.master$loc <- as.factor(aps.master$loc)
abs350_t <- readRDS(file="Data/abs350_t.rds")

## Load EEMs
FOR_eem <- readRDS(file="Data/EEM/FOR_eem.rds")
SNO_eem <- readRDS(file="Data/EEM/SNO_eem.rds")
GLO_eem <- readRDS(file="Data/EEM/GLO_eem.rds")
GRA_eem <- readRDS(file="Data/EEM/GRA_eem.rds")
PLA_eem <- readRDS(file="Data/EEM/PLA_eem.rds")
SKY_eem <- readRDS(file="Data/EEM/SKY_eem.rds")
MUS_eem <- readRDS(file="Data/EEM/MUS_eem.rds")


#Assign Colors
colores <- scico(7,palette="romaO",begin = 0.1,
                 end = 0.9) #Color assignment

```

These scripts and the included datafiles were used to produce the figures of the following research article:

Endres, L., Jacquin, C., González-Lemos, S., Rodríguez-Rodríguez, L., Sliwinski, J., Kaushal, N., . . . Stoll, H. (2023). Climatic and cave settings influence on drip water fluorescent organic matter with implications for fluorescent laminations in stalagmites. Quaternary Research, 1-21. doi:10.1017/qua.2023.41

Note that only the code is given for figures produced in R. Code has been transferred to Rmarkdown and slightly adapted for better documentation, you can open these files and look at the code e.g. with Rstudio. Data and code are released under a CC BY 4.0 license, which requires attribution (please use the citation above) but permits unrestricted re-use, distribution and reproduction.

For drip water chemical data, please also cite:

Kost, O., González-Lemos, S., Rodríguez-Rodríguez, L., Sliwinski, J., Endres, L., Haghipour, N., Stoll, H., 2023. Relationship of seasonal variations in drip water δ 13 C DIC , δ 18 O, and trace elements with surface and physical cave conditions of La Vallina cave, NW Spain. Hydrol. Earth Syst. Sci. 27, 2227–2255. doi:10.5194/hess-27-2227-2023

Please feel free to reach out, when you spot errors in the code & need additional data/ information (endres@erdw.ethz.ch).


## Figure 2
```{r, echo=FALSE}
pf5 <- readRDS(file="Data/PARAFAC/pf5_model.rds")
results_pf5 <- readRDS(file ="Data/PARAFAC/results_pf5.rds") #This object I use further for plotting

##Setup PARAFAC components for plotting
data <- pf5[[1]]
table <- data %>% eempf_comp_mat() #eem_list
table <- lapply(table %>% names(),function(name){
  table[[name]] %>% mutate(sample = name)
}) %>% bind_rows() %>%
  mutate(sample = factor(sample, levels = colnames(data$A)))

p1 <- table %>% filter(sample=="Comp.1") %>%
  ggplot(aes(x = as.numeric(ex), y = as.numeric(em), z = value))+ 
  geom_contour_filled(colour = "black", size = 0.1)+
  labs(x = "Ex. (nm)", y = "Em. (nm)")+#xlim(240,500) + 
  theme_minimal(base_size = 9) + theme(panel.background = element_blank(),
                                        legend.position='none',
                                        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  ggtitle("C1 (\"humic-like\") ")+
  scale_fill_scico_d(drop = FALSE,palette='lajolla',name = "Normalized \nfluorescence \nintensity",begin =1,end=0)+
  scale_x_continuous(expand = expansion(0),limits=c(240,500)) + 
  scale_y_continuous(expand = expansion(0)) 

p2 <- table %>% filter(sample=="Comp.2") %>%
  ggplot(aes(x = as.numeric(ex), y = as.numeric(em), z = value))+
  geom_contour_filled(colour = "black", size = 0.1)+
  labs(x = "Ex. (nm)", y = "Em. (nm)")+xlim(240,500) + 
  theme_minimal(base_size = 9) + theme(panel.background = element_blank(),
                                        legend.position='none',
                                        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  ggtitle("C2 (\"tyrosine-like\") ")+
  scale_fill_scico_d(drop = FALSE,palette='lajolla',name = "Normalized \nfluorescence \nintensity",begin =1,end=0)+
  scale_x_continuous(expand = expansion(0),limits=c(240,500)) + 
  scale_y_continuous(expand = expansion(0)) 

p3 <- table %>% filter(sample=="Comp.3") %>%
  ggplot(aes(x = as.numeric(ex), y = as.numeric(em), z = value))+
  geom_contour_filled(colour = "black", size = 0.1)+
  labs(x = "Ex. (nm)", y = "Em. (nm)")+xlim(240,500) + 
  theme_minimal(base_size = 9) + theme(panel.background = element_blank(),
                                        legend.position='none',
                                        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  ggtitle("C3 (\"fossil-like\") ")+
  scale_fill_scico_d(drop = FALSE,palette='lajolla',name = "Normalized \nfluorescence \nintensity",begin =1,end=0)+
  scale_x_continuous(expand = expansion(0),limits=c(240,500)) + 
  scale_y_continuous(expand = expansion(0)) 

p4 <- table %>% filter(sample=="Comp.4") %>%
  ggplot(aes(x = as.numeric(ex), y = as.numeric(em), z = value))+ 
  geom_contour_filled(colour = "black", size = 0.1)+
  labs(x = "Ex. (nm)", y = "Em. (nm)")+xlim(240,500) + 
  theme_minimal(base_size = 9) + theme(panel.background = element_blank(),
                                        legend.position='none',
                                        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  ggtitle("C4 (\"protein-like\") ")+
  scale_fill_scico_d(drop = FALSE,palette='lajolla',name = "Normalized \nfluorescence \nintensity",begin =1,end=0)+
  scale_x_continuous(expand = expansion(0),limits=c(240,500)) + 
  scale_y_continuous(expand = expansion(0)) 

p5 <- table %>% filter(sample=="Comp.5") %>%
  ggplot(aes(x = as.numeric(ex), y = as.numeric(em), z = value))+ 
  geom_contour_filled(colour = "black", size = 0.1)+
  labs(x = "Ex. (nm)", y = "Em. (nm)")+xlim(240,500) + 
  theme_minimal(base_size = 9) + theme(panel.background = element_blank(),
                                        legend.position='none',
                                        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  ggtitle("C5 (\"fulvic-like\") ")+
  scale_fill_scico_d(drop = FALSE,palette='lajolla',name = "Normalized \nfluorescence \nintensity",begin =1,end=0)+
  scale_x_continuous(expand = expansion(0),limits=c(240,500)) + 
  scale_y_continuous(expand = expansion(0)) 


### Prepare max Em/Ex plots
c <- eempf_comp_mat(pf5[[1]])
c1_ex <- data.frame(ex=levels(as.factor(c$Comp.1$ex)),val=NA)
c2_ex <- c1_ex
c3_ex <- c1_ex
c4_ex <- c1_ex
c5_ex <- c1_ex

l1 <- levels(as.factor(c$Comp.1$ex))
for (il in l1){
  c1_ex[c1_ex$ex==il,"val"] <-  c$Comp.1 %>% filter(ex==il) %>% dplyr::select(value) %>% max()
  c2_ex[c1_ex$ex==il,"val"] <-  c$Comp.2 %>% filter(ex==il) %>% dplyr::select(value) %>% max()
  c3_ex[c1_ex$ex==il,"val"] <-  c$Comp.3 %>% filter(ex==il) %>% dplyr::select(value) %>% max()
  c4_ex[c1_ex$ex==il,"val"] <-  c$Comp.4 %>% filter(ex==il) %>% dplyr::select(value) %>% max()
  c5_ex[c1_ex$ex==il,"val"] <-  c$Comp.5 %>% filter(ex==il) %>% dplyr::select(value) %>% max()
}

c1_em <- data.frame(em=levels(as.factor(c$Comp.1$em)),val=NA)
c2_em <- c1_em
c3_em <- c1_em
c4_em <- c1_em
c5_em <- c1_em  
l2 <- levels(as.factor(c$Comp.1$em))
for (il in l2){
  c1_em[c1_em$em==il,"val"] <-  c$Comp.1 %>% filter(em==il) %>% dplyr::select(value) %>% max()
  c2_em[c1_em$em==il,"val"] <-  c$Comp.2 %>% filter(em==il) %>% dplyr::select(value) %>% max()
  c3_em[c1_em$em==il,"val"] <-  c$Comp.3 %>% filter(em==il) %>% dplyr::select(value) %>% max()
  c4_em[c1_em$em==il,"val"] <-  c$Comp.4 %>% filter(em==il) %>% dplyr::select(value) %>% max()
  c5_em[c1_em$em==il,"val"] <-  c$Comp.5 %>% filter(em==il) %>% dplyr::select(value) %>% max()
}

l1 <- ggplot() +
  geom_line(data=c1_em,aes(x=as.numeric(em),y=val)) +
  geom_line(data=c1_ex,aes(x=as.numeric(ex),y=val),linetype = "dashed") + theme_minimal(base_size=10) +
  labs(x="Wavelength (nm)",y="Spectral loading")

l2 <- ggplot() +
  geom_line(data=c2_em,aes(x=as.numeric(em),y=val)) +
  geom_line(data=c2_ex,aes(x=as.numeric(ex),y=val),linetype = "dashed") + theme_minimal(base_size=10) +
  geom_line(aes(x=c(450,535),y=c(0.95,0.95))) + geom_text(aes(x=540,y=0.95,label="Em."),size = 3,hjust="left")+
  geom_line(aes(x=c(450,535),y=c(0.85,0.85)),linetype="dashed") + geom_text(aes(x=540,y=0.85,label="Ex."),size = 3,hjust="left")+
  labs(x="Wavelength",y="Spectral loading")

l3 <- ggplot() +
  geom_line(data=c3_em,aes(x=as.numeric(em),y=val)) +
  geom_line(data=c3_ex,aes(x=as.numeric(ex),y=val),linetype = "dashed") + theme_minimal(base_size=10) +
  labs(x="Wavelength",y="Spectral loading")

l4 <- ggplot() +
  geom_line(data=c4_em,aes(x=as.numeric(em),y=val)) +
  geom_line(data=c4_ex,aes(x=as.numeric(ex),y=val),linetype = "dashed") + theme_minimal(base_size=10) +
  labs(x="Wavelength",y="Spectral loading")

l5 <- ggplot() +
  geom_line(data=c5_em,aes(x=as.numeric(em),y=val)) +
  geom_line(data=c5_ex,aes(x=as.numeric(ex),y=val),linetype = "dashed") + theme_minimal(base_size=10) +
  labs(x="Wavelength",y="Spectral loading")


plotlist <-list(p1+rremove("xlab"),
                p2+rremove("ylab")+ rremove("y.text")+ rremove("y.ticks")+rremove("xlab"),
                p3 + rremove("ylab")+ rremove("y.text")+ rremove("y.ticks"),
                p4 + rremove("ylab")+ rremove("y.text")+ rremove("y.ticks")+rremove("xlab"),
                p5 + rremove("ylab")+ rremove("y.text")+ rremove("y.ticks")+rremove("xlab"),
                l1+rremove("xlab") ,
                l2 + rremove("ylab")+ rremove("y.text")+ rremove("y.ticks")+rremove("xlab"),
                l3 + rremove("ylab")+ rremove("y.text")+ rremove("y.ticks"),
                l4 + rremove("ylab")+ rremove("y.text")+ rremove("y.ticks")+rremove("xlab"),
                l5 + rremove("ylab")+ rremove("y.text")+ rremove("y.ticks")+rremove("xlab"))

APlot<- wrap_plots(plotlist,nrow=2) + plot_layout(guides = "collect") &
  theme(legend.position='right')

#A plot
##B plot

# Measurement of Bedrock, Correct EEMs here

### EEM Processing
#Load EEM and apply all corrections
#Export EEM for all locations 
#Only Drip-water samples here (new)

# In this script all samples (exported S1cR1c Samples from Origin) are loaded and 
# Cut to the same Ex-Em matrix
# an appropriate blank is removed. (Blank Correction)
# Raman scattering is corrrected
# IFE correction
# Raman normalisation
# Resampled for common target resolution
# Exported with and without resampling


#library(eemR) 
#library(shiny)
#library(DT)
#library(tidyverse)
#ls("package:eemR")
#IMPORT .dat files 

#Load data
pem_rm <- readRDS("Data/EEM/Bedrock_eem.rds")

#plot(pem_rm[[1]])
M1 <- matrix(pem_rm[[1]]$x,nrow=length(pem_rm[[1]]$em),dimnames=list(pem_rm[[1]]$em,pem_rm[[1]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
v <- ggplot()
BPlot<-v + geom_contour_filled(M2, mapping=aes(Em, Ex, z = Freq),size = 0, breaks = c(-50,50,100,150,200,250,300,350,400,450,500,550,600)) + 
  labs(title=NULL) + #ylim(250,350) + xlim(250,600)+
  scale_fill_scico_d(drop = FALSE,palette='batlow',name = "fluorescence intensity \n(a.u.)") +
  coord_flip()+
  theme_minimal(base_size = 9) + theme(panel.background = element_blank(),
                                        legend.position='right',
                                        panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  geom_point(mapping=aes(c(333,333),c(250,280)),shape=17,fill="yellow", color="yellow", size=2)+
  scale_x_continuous(expand = expansion(0),limits=c(250,600),name="Em.") + 
  scale_y_continuous(expand = expansion(0),limits=c(250,350),name="Ex.") + guides(fill=guide_legend(ncol=2))+
  ggtitle("Bedrock")

ggarrange(APlot,
          ggarrange(BPlot,ggplot()+theme_void(),ncol = 2, labels = c("B", ""),widths=c(1,1),
                    font.label = list(size = 10, color = "black", face = "bold", family = NULL)),
          nrow = 2, 
          labels = "A",
          heights =c(2,1),
          font.label = list(size = 10, color = "black", face = "bold", family = NULL)# Labels of the scatter plot
) 
#A4: 297 mm x 210 mm
```

Figure 2. Drip water parallel factor analysis (PARAFAC) model and bedrock endmember excitation-emission matrix (EEM). (A) Drip water 5-component PARAFAC model and its spectral loadings. Fluorescence intensity is normalized to unity. Spectral loadings maxima in emission and excitation wavelengths are indicated with solid and dashed lines, respectively. (B) EEM of dissolved organic-rich bedrock. Fluorescence intensity is given in arbitrary units (a.u.). Yellow triangles indicate peak positions of drip water PARAFAC component C3 for comparison.

## Figure 4
```{r Fig4,echo=FALSE}

#Slope ratio
v <- 
  aps.master %>%
  mutate(loc = fct_relevel(loc, 
                           "FOR","SNO", "GLO","GRA","PLA","SKY","MUS")) %>%
  ggplot(aes(x=loc,y=sloperatio)) +geom_jitter(aes(color=loc),width=0.1,alpha=0.5) + theme_classic2(base_size=9) + stat_boxplot(outlier.shape=NA,fill=NA) +
  labs(x="Sampling location",y="Slope ratio",color="Location")+
  scale_color_scico_d(palette="romaO",begin = 0.1,
                      end = 0.9)+
  theme(axis.text.x=element_text(angle=60, hjust=1),legend.position="none")

#Absorption spectra
a <- 
  abs350_t %>% group_by(loc) %>% filter(loc %in% c("FOR","SNO", "GLO","GRA","PLA","SKY","MUS")) %>%
  summarise_all(median,na.rm=TRUE) %>% mutate(loc = fct_relevel(loc, 
                                                              "FOR","SNO", "GLO","GRA","PLA","SKY","MUS"))  %>% 
  gather("param","value",-loc) %>% 
  ggplot(aes(x=as.numeric(param),y=as.numeric(value),color=loc)) +
  geom_smooth(se=FALSE,na.rm=TRUE,span=0.1,alpha=0.25,linewidth=0.5) + 
  coord_cartesian(xlim = c(200,500),
                  ylim = c(0,40)) + theme_classic2(base_size = 9) +
  labs(x="Wavelength (nm)",y="Absorption coefficient [m^-1]",color="Location")+
  scale_color_scico_d(palette="romaO",begin = 0.1,
                      end = 0.9) + theme(legend.position = c(0.9, 0.55),
                                         legend.title=element_text(size=8), 
                                         legend.text=element_text(size=7)
                                         ) + scale_y_continuous(trans='sqrt')

#Plot
#subplot(a,v,nrows=2) 
#ggsave(filename="Endres_Fig4.tiff",height=160*1.3,width=80*1.3,units='mm',dpi=600)
a
v

```

Figure 4. Absorption properties of drip water samples for each sampling location. (A) Loess smoothed median absorption spectra for all locations. (B) Spectral slope ratio values for individual absorbance measurements.


## Figure 5

```{r Fig. 5,echo=FALSE}

# A: AVG and SD arrays
# B: Stacked Barplot
#Calculate AVG and SD matrices
#Spatial variability of Fluorescence in LaVallina.
#EEMs have been pre-processed with the library eemR.
my.list <- list()
for (i in 1:length(FOR_eem)){my.list[[i]]<-FOR_eem[[i]]$x}
FOR_avg <- apply(simplify2array(my.list), 1:2, mean)
FOR_sd <- apply(simplify2array(my.list), 1:2, sd)

my.list <- list()
for (i in 1:length(SNO_eem)){my.list[[i]]<-SNO_eem[[i]]$x}
SNO_avg <- apply(simplify2array(my.list), 1:2, mean)
SNO_sd <- apply(simplify2array(my.list), 1:2, sd)

my.list <- list()
for (i in 1:length(GLO_eem)){my.list[[i]]<-GLO_eem[[i]]$x}
GLO_avg <- apply(simplify2array(my.list), 1:2, mean)
GLO_sd <- apply(simplify2array(my.list), 1:2, sd)

my.list <- list()
for (i in 1:length(GRA_eem)){my.list[[i]]<-GRA_eem[[i]]$x}
GRA_avg <- apply(simplify2array(my.list), 1:2, mean)
GRA_sd <- apply(simplify2array(my.list), 1:2, sd)

my.list <- list()
for (i in 1:length(SKY_eem)){my.list[[i]]<-SKY_eem[[i]]$x}
SKY_avg <- apply(simplify2array(my.list), 1:2, mean)
SKY_sd <- apply(simplify2array(my.list), 1:2, sd)

my.list <- list()
for (i in 1:length(PLA_eem)){my.list[[i]]<-PLA_eem[[i]]$x}
PLA_avg <- apply(simplify2array(my.list), 1:2, mean)
PLA_sd <- apply(simplify2array(my.list), 1:2, sd)

my.list <- list()
for (i in 1:length(MUS_eem)){my.list[[i]]<-MUS_eem[[i]]$x}
MUS_avg <- apply(simplify2array(my.list), 1:2, mean)
MUS_sd <- apply(simplify2array(my.list), 1:2, sd)

###A Compute Plots for average fluorescence 
###(Warning messages are because Ex/Em wavelength are cut with ylim)
#FOR
M1 <- matrix(FOR_avg,nrow=length(FOR_eem[[i]]$em),dimnames=list(FOR_eem[[i]]$em,FOR_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
p1 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.015,0.02,0.025,0.03,0.04,0.05,0.075,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank(),plot.title = element_text(hjust = 0.5)) + ylim(250,500) + coord_flip() + labs(subtitle="Mean EEM") + 
  xlab(expression(atop(bold("FOR (9)"), paste("Em"))))+
  scale_fill_scico_d(drop = FALSE,palette='batlow') +
  #scale_fill_batlow_d(drop = FALSE) +
  theme_minimal(base_size=10) + theme(plot.subtitle=element_text(hjust = 0.5),axis.title.y = element_text(colour=colores[1]))

#SNO
M1 <- matrix(SNO_avg,nrow=length(SNO_eem[[i]]$em),dimnames=list(SNO_eem[[i]]$em,SNO_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
p2 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.015,0.02,0.025,0.03,0.04,0.05,0.075,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank()) + ylim(250,500) + coord_flip() + #labs(title="SNO") +
  xlab(expression(atop(bold("SNO (3)"), paste("Em"))))+
  scale_fill_scico_d(drop = FALSE,palette='batlow') +theme_minimal(base_size=10) +
  theme(axis.title.y = element_text(colour=colores[2]))

#GLO
M1 <- matrix(GLO_avg,nrow=length(GLO_eem[[i]]$em),dimnames=list(GLO_eem[[i]]$em,GLO_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
p3 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.015,0.02,0.025,0.03,0.04,0.05,0.075,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank()) + ylim(250,500) +  coord_flip() + #labs(title="GLO") +
  xlab(expression(atop(bold("GLO (13)"), paste("Em"))))+
  scale_fill_scico_d(drop = FALSE,palette='batlow',name = "Mean level (R.U.)") +theme_minimal(base_size=10)+
  theme(axis.title.y = element_text(colour=colores[3]))

#GRA
M1 <- matrix(GRA_avg,nrow=length(GRA_eem[[i]]$em),dimnames=list(GRA_eem[[i]]$em,GRA_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
p4 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.015,0.02,0.025,0.03,0.04,0.05,0.075,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank()) + ylim(250,500) +  coord_flip() + #labs(title="GRA") +
  xlab(expression(atop(bold("GRA (11)"), paste("Em"))))+
  scale_fill_scico_d(drop = FALSE,palette='batlow') +theme_minimal(base_size=10)+
  theme(axis.title.y = element_text(colour=colores[4]))

#SKY
M1 <- matrix(SKY_avg,nrow=length(SKY_eem[[i]]$em),dimnames=list(SKY_eem[[i]]$em,SKY_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
p5 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.015,0.02,0.025,0.03,0.04,0.05,0.075,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank()) + ylim(250,500) +  coord_flip() + #labs(title="SKY") +
  xlab(expression(atop(bold("SKY (13)"), paste("Em"))))+
  scale_fill_scico_d(drop = FALSE,palette='batlow') +theme_minimal(base_size=10)+
  theme(axis.title.y = element_text(colour=colores[6]))

#PLA
M1 <- matrix(PLA_avg,nrow=length(PLA_eem[[i]]$em),dimnames=list(PLA_eem[[i]]$em,PLA_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
p6 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.015,0.02,0.025,0.03,0.04,0.05,0.075,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank()) + ylim(250,500) +  coord_flip() + #labs(title="PLA") +
  xlab(expression(atop(bold("PLA (13)"), paste("Em"))))+
  scale_fill_scico_d(drop = FALSE,palette='batlow') +theme_minimal(base_size=10)+
  theme(axis.title.y = element_text(colour=colores[5]))

#MUS
M1 <- matrix(MUS_avg,nrow=length(MUS_eem[[i]]$em),dimnames=list(MUS_eem[[i]]$em,MUS_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
p7 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.015,0.02,0.025,0.03,0.04,0.05,0.075,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank()) + ylim(250,500) +  coord_flip() + #labs(title="MUS") +
  xlab(expression(atop(bold("MUS (3)"), paste("Em"))))+
  scale_fill_scico_d(drop = FALSE,palette='batlow') +theme_minimal(base_size=10)+
  theme(axis.title.y = element_text(colour=colores[7]),axis.text.x=element_text(angle=60, hjust=1))


###B Compute Plots for SD fluorescence 
bl2 <- colorRampPalette(c("#00195911","#001959FF"),alpha=TRUE)(7) #color palette for Standard deviation

#FOR
M1 <- matrix(FOR_sd,nrow=length(FOR_eem[[i]]$em),dimnames=list(FOR_eem[[i]]$em,FOR_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
q1 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0.1, breaks = c(-0.1,0.01,0.02,0.03,0.05,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank(),plot.subtitle = element_text(hjust = 0.5)) + ylim(250,500) +  coord_flip() +
  theme_minimal(base_size=10) + labs(subtitle="SD EEM") + theme(plot.subtitle = element_text(hjust = 0.5)) +
  scale_fill_manual(values=bl2,drop=FALSE)

#SNO
M1 <- matrix(SNO_sd,nrow=length(SNO_eem[[i]]$em),dimnames=list(SNO_eem[[i]]$em,SNO_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
q2 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.02,0.03,0.05,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank()) + ylim(250,500) +coord_flip() +
  theme_minimal(base_size=10) +
  scale_fill_manual(values=bl2,drop=FALSE)

#GLO
M1 <- matrix(GLO_sd,nrow=length(GLO_eem[[i]]$em),dimnames=list(GLO_eem[[i]]$em,GLO_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
q3 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.02,0.03,0.05,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank()) + ylim(250,500) +coord_flip() +
  theme_minimal(base_size=10) +
  scale_fill_manual(values=bl2,drop=FALSE,name = "SD level (R.U.)")

#GRA
M1 <- matrix(GRA_sd,nrow=length(GRA_eem[[i]]$em),dimnames=list(GRA_eem[[i]]$em,GRA_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
q4 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.02,0.03,0.05,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank()) + ylim(250,500) +coord_flip() +
  theme_minimal(base_size=10) +
  scale_fill_manual(values=bl2,drop=FALSE)

#SKY
M1 <- matrix(SKY_sd,nrow=length(SKY_eem[[i]]$em),dimnames=list(SKY_eem[[i]]$em,SKY_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
q5 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.02,0.03,0.05,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank()) + ylim(250,500) +coord_flip() +
  theme_minimal(base_size=10) +
  scale_fill_manual(values=bl2,drop=FALSE)

#PLA
M1 <- matrix(PLA_sd,nrow=length(PLA_eem[[i]]$em),dimnames=list(PLA_eem[[i]]$em,PLA_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
q6 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.02,0.03,0.05,0.1,0.2,0.4)) + 
  theme(panel.background = element_blank()) + ylim(250,500) +coord_flip() +
  theme_minimal(base_size=10) +
  scale_fill_manual(values=bl2,drop=FALSE)

#MUS
M1 <- matrix(MUS_sd,nrow=length(MUS_eem[[i]]$em),dimnames=list(MUS_eem[[i]]$em,MUS_eem[[i]]$ex))
M2 <- as.data.frame(as.table(M1))
M2$Ex <- as.numeric(as.character(M2$Var2))
M2$Em <- as.numeric(as.character(M2$Var1))
M2$Freq[length(M2$Freq)] <- 0.20
q7 <- ggplot(M2, aes(Em, Ex, z = Freq)) + geom_contour_filled(size = 0, breaks = c(-0.1,0.01,0.02,0.03,0.05,0.1,0.2,0.4)) + 
  ylim(250,500) +coord_flip() +
  theme_minimal(base_size=10) + theme(panel.background = element_blank(),axis.text.x=element_text(angle=60, hjust=1)) +
  scale_fill_manual(values=bl2,drop=FALSE)


### Compute Plot A

colores <- scico(7,palette="romaO",begin = 0.1, end = 0.9) #colorpalette as discrete values

LegendList <- list(p1 + rremove("xlab")+ rremove("x.text")+ rremove("x.ticks")+
                     theme(legend.position="none"),
                   q1 + rremove("xlab")+ rremove("x.text")+ rremove("x.ticks") +
                     rremove("ylab")+ rremove("y.text")+ rremove("y.ticks")+
                     theme(legend.position="none"),
                   p2 + rremove("xlab")+ rremove("x.text")+ rremove("x.ticks")+
                     theme(legend.position="none"),
                   q2 + rremove("xlab")+ rremove("x.text")+ rremove("x.ticks") +
                     rremove("ylab")+ rremove("y.text")+ rremove("y.ticks")+
                     theme(legend.position="none"),
                   p3 + rremove("xlab")+ rremove("x.text")+ rremove("x.ticks")
                   ,
                   q3 + rremove("xlab")+ rremove("x.text")+ rremove("x.ticks") +
                     rremove("ylab")+ rremove("y.text")+ rremove("y.ticks"),
                   p4 + rremove("xlab")+ rremove("x.text")+ rremove("x.ticks")+
                     theme(legend.position="none"),
                   q4 + rremove("xlab")+ rremove("x.text")+ rremove("x.ticks") +
                     rremove("ylab")+ rremove("y.text")+ rremove("y.ticks")+
                     theme(legend.position="none"),
                   p6 + rremove("xlab")+ rremove("x.text")+ rremove("x.ticks")+
                     theme(legend.position="none"),
                   q6 + rremove("xlab")+ rremove("x.text")+ rremove("x.ticks") +
                     rremove("ylab")+ rremove("y.text")+ rremove("y.ticks")+
                     theme(legend.position="none"),
                   p5+theme(legend.position="none") +
                     rremove("xlab")+ rremove("x.text")+ rremove("x.ticks"),
                   q5+theme(legend.position="none")+
                     rremove("xlab")+ rremove("x.text")+ rremove("x.ticks")+
                     rremove("ylab")+ rremove("y.text")+ rremove("y.ticks"),
                   p7 + 
                     theme(legend.position="none"),
                   q7  +
                     rremove("ylab")+ rremove("y.text")+ rremove("y.ticks")+
                     theme(legend.position="none")
)

#A: Plot 
APlot <- wrap_plots(LegendList,ncol = 2,nrow = 7)
APlot + plot_layout(guides = "collect") + 
  theme(legend.justification = "top")
#ggsave(filename="Fig5A.tiff",width=120,height=220,units='mm',dpi=600)


# B: Stacked Barplot
## B: stacked barplot from each location
#load data
df <- readRDS(file="Data/LaVallina_Fluo_pub.rds")

# Plot
colores <- scico(5,palette="tofino",begin = 0.1,
                 end = 0.9)

lookup <- c(C1="Comp.1",C2="Comp.2",C3="Comp.3",C4="Comp.4",C5="Comp.5")
plotter <- df %>% mutate(loc = fct_relevel(loc, 
                                               "FOR","SNO", "GLO","GRA","PLA","SKY","MUS")) %>% 
  select(loc,Comp.4,Comp.2,Comp.3,Comp.5,Comp.1) %>% rename(all_of(lookup)) %>%  
  aggregate(. ~ loc,mean) %>% gather("comp","value",-loc) 
  
plotter$comp <- as.factor(plotter$comp)  
plotter %>% mutate(comp = fct_relevel(comp,"C4","C2","C3","C5","C1")) %>%  
  ggplot(aes(x=loc,y=value,fill=comp)) + xlab("Sampling location") + ylab("stacked fluorescence intensity")+labs(fill="PARAFAC \ncomponent")+
  geom_bar(position="stack", stat="identity") +theme_classic2(base_size=8)+
    theme(axis.text.x=element_text(angle=60, hjust=1),legend.key.size = unit(0.5, 'cm'))+
    scale_fill_manual(values=colores,drop=FALSE)
  
#ggsave(filename="Fig5B.tiff",width=60,height=60,units='mm',dpi=600)
```

## Figure 6
```{r Fig6, echo=FALSE}

df <- readRDS(file="Data/LaVallina_Fluo_pub.rds") 
#df$Al_ppm <- as.numeric(df$Al_ppm)
#df$lubridate <- dmy(df$datee)

df_long <- df %>% gather("param","value",-lubridate,-loc)

#Define new variable names
var2_names <- c(
  Comp.1 = "C1 (\"humic-like\")" ,
  Comp.2 = "C2 (\"tyrosine-like\")" ,
  Comp.3 = "C3 (\"fossil-like\")" ,
  Comp.4 = "C4 (\"protein-like\")" ,
  Comp.5 = "C5 (\"fulvic-like\")" ,
  C_oddmean = "C1+C3+C5" ,
  C_evenmean = "C2+C4" ,
  C1C5ratio = "C1/C5" ,
  C1C3ratio = "C1/C3" ,
  C3C1ratio = "C3/C1" ,
  C3C5ratio = "C3/C5" ,
  sloperatio ="SR",
  bix = "BIX",
  fi = "FI",
  hix = "HIX",
  drip_d13C_DIC = "drip water d13C",
  driprate = "drip rate",
  #logdrip = "log(drip rate)",
  a300 = "a300"
)

#Functions to rename variables
variable_labeller <- function(variable,value){
  return(variable_names[value])
}

capitalize <- function(string) {
  substr(string, 1, 1) <- toupper(substr(string, 1, 1))
  string
}

# Compute vegetation gradient (defines Symbol in Plot)
df_long$loc <- as.factor(df_long$loc)
df_long$veggradient <- 0
df_long[df_long$loc %in% c("FOR","SNO"),]$veggradient <- "F"#Forest  
df_long[df_long$loc %in% c("GLO","GRA"),]$veggradient <- "B" #Bush
df_long[df_long$loc %in% c("PLA","SKY","MUS"),]$veggradient <- "P" #Pasture


A <- df_long %>% 
  filter(param %in% c("Comp.1","Comp.2","Comp.3","Comp.4","Comp.5")) %>%
  mutate(loc = fct_relevel(loc, 
                           "FOR","SNO", "GLO","GRA","PLA","SKY","MUS"),
         param = fct_relevel(param,"Comp.1","Comp.5","Comp.3","Comp.2","Comp.4")) %>%
  ggplot(aes(y=sqrt(as.numeric(value)),x=lubridate))+
      geom_line(mapping=aes(colour=loc)) +
      geom_point(mapping=aes(shape=as.factor(veggradient),colour=loc)) +
      facet_grid(loc ~ param,scales = "free",labeller=labeller(.default=capitalize,
                                                           param=var2_names),switch="y") +
      coord_cartesian(ylim = c(-0, 0.85)) +
      theme_minimal() +
      theme(axis.text.x=element_text(angle=60, hjust=1),legend.position="none") +
      labs(x = "Date", y = NULL) + scale_x_date(date_labels = "%b %y") +
      scale_y_continuous(position="right") + scale_color_scico_d(palette="romaO",begin = 0.1,
                      end = 0.9)

A


```

Figure 6. Temporal evolution of the 5 components of the PARAFAC model throughout the monitored period at each site. Each component y axis is given in nor- malized PARAFAC fluorescence intensity.

## Figure 8
```{r Fig8, echo=FALSE}

#Data
df <- readRDS(file="Data/LaVallina_Fluo_pub.rds") 

# Plot A
p1 <- df %>% mutate(loc = fct_relevel(loc, 
                                                     "FOR","SNO", "GLO","GRA","PLA","SKY","MUS")) %>%  
  ggplot(aes(x=as.factor(thickness),y=Comp.1+Comp.5,colour=loc))+
  geom_boxplot() + theme_classic2() +labs(x="Cover thickness [m]",y="C1+C5")+
  scale_color_scico_d(palette="romaO",begin = 0.1,
                      end = 0.9)

#Plot B
p2 <- df %>% mutate(loc = fct_relevel(loc, 
                                                      "FOR","SNO", "GLO","GRA","PLA","SKY","MUS")) %>%
  filter(loc %in% c("FOR","GLO","GRA","SKY","PLA")) %>%
  ggplot(aes(x=as.numeric(d18O_locvar),y=Comp.1+Comp.5,colour=loc))+
  geom_boxplot() + theme_minimal(base_size = 10) +labs(x=TeX("$\\delta ^{18}O$ standard deviation"),y="C1+C5",colour="drip site") +
  scale_color_scico_d(palette="romaO",begin = 0.1,
                      end = 0.9,drop=FALSE)+ theme_classic2()

#Plot C
p3 <- df %>% mutate(loc = fct_relevel(loc, 
                                                      "FOR","SNO", "GLO","GRA","PLA","SKY","MUS")) %>%
  filter(loc %in% c("FOR","GLO","GRA","SKY","PLA")) %>%
  ggplot(aes(x=as.numeric(d18O_locvar),y=C3_C1C5ratio,colour=loc))+
  geom_boxplot() + theme_minimal(base_size = 10) +labs(x=TeX("$\\delta ^{18}O$ standard deviation"),y="C3:(C1+C5) ratio",colour="drip site") +
  scale_color_scico_d(palette="romaO",begin = 0.1,
                      end = 0.9,drop=FALSE)+ theme_classic2()

#Create combined plot
library(patchwork)
wrap_plots(p1+theme(legend.position="none",axis.text.x=element_text(angle=60, hjust=1)),
           p2 +theme(axis.text.x=element_text(angle=60, hjust=1)),
           p3 +theme(axis.text.x=element_text(angle=60, hjust=1)),
           guides="collect") + plot_annotation(tag_levels = 'A')

#ggsave(filename="Endres_Fig8.tiff",width=200*1.3,height=80*1.3,units='mm',dpi=600)

```

Figure 8. Overview of the relationship between fluorescence and cave settings. (A) Comparison of the summed C1 and C5 (humic-like and fulvic-like) components plotted versus ascending thickness of bedrock cover over the drip water sampling site. (B) Comparison of summed C1 and C5 components plotted versus the drip water δ18O variance. (C) Comparison of the ratio of C3/(C1+C5), interpreted as the ratio of reworked or fossil components to humic-like and fulvic-like components, plotted against the drip water δ18O variance. The δ18O variance is computed from data in Kost et al. (2023) and is thought to increase for shorter drip water residence times.

## Figure 9
```{r, echo=FALSE}

#load data
df <- readRDS(file="Data/LaVallina_Fluo_pub.rds")

#selected locations
locs <- c("FOR","GLO","GRA","PLA","SKY")

### One plot per location: Temperature first, then rain, then driprate
#GRA
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("T_10d cold","T_10d warm"))
mm <- levels(as.factor(df$T_10d))

C4_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(T_10d,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(T_10d,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(T_10d,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(T_10d,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(T_10d,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(T_10d,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(T_10d,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(T_10d,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(T_10d,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(T_10d,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.5,loc) 

T_GRA <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))
T_GRA [1:nrow(C4_low),'cat'] <- levels(f)[1]
T_GRA[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]
##

t1 <- T_GRA %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill=cat))+
  geom_boxplot() + 
  #geom_dotplot(binaxis = "y",binwidth) +
  #geom_point(alpha=0.2) +
  #geom_jitter(alpha=0.5,mapping=aes(colour=cat),width = 0.1) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC model components",y="normalized fluorescence intensity",fill="Temperature")+
  scale_fill_scico_d(palette="bilbao",begin = 0,
                      end = 0.9,alpha=0.6)

#GLO
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("T_10d cold","T_10d warm"))
mm <- levels(as.factor(df$T_10d))

C4_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(T_10d,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(T_10d,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(T_10d,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(T_10d,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(T_10d,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(T_10d,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(T_10d,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(T_10d,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(T_10d,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(T_10d,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.5,loc) 


T_GLO <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))

T_GLO [1:nrow(C4_low),'cat'] <- levels(f)[1]
T_GLO[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]


t2 <- T_GLO  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill=cat))+
  geom_boxplot() + 
  #geom_dotplot(binaxis = "y",binwidth) +
  #geom_point(alpha=0.2) +
  #geom_jitter(alpha=0.5,mapping=aes(colour=cat),width = 0.1) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized fluorescence intensity",fill="Temperature")+
  scale_fill_scico_d(palette="bilbao",begin = 0,
                     end = 0.9,alpha=0.6)

#SKY
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("T_10d cold","T_10d warm"))
mm <- levels(as.factor(df$T_10d))

C4_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(T_10d,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(T_10d,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(T_10d,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(T_10d,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(T_10d,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(T_10d,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(T_10d,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(T_10d,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(T_10d,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(T_10d,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.5,loc) 


T_SKY <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))


T_SKY [1:nrow(C4_low),'cat'] <- levels(f)[1]
T_SKY[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]



t3 <- T_SKY  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill=cat))+
  geom_boxplot() + 
  #geom_dotplot(binaxis = "y",binwidth) +
  #geom_point(alpha=0.2) +
  #geom_jitter(alpha=0.5,mapping=aes(colour=cat),width = 0.1) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized fluorescence intensity",fill="Temperature")+
  scale_fill_scico_d(palette="bilbao",begin = 0,
                     end = 0.9,alpha=0.6)

#FOR
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("T_10d cold","T_10d warm"))
mm <- levels(as.factor(df$T_10d))

C4_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(T_10d,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(T_10d,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(T_10d,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(T_10d,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(T_10d,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(T_10d,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(T_10d,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(T_10d,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(T_10d,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(T_10d,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.5,loc) 


T_FOR <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))

T_FOR [1:nrow(C4_low),'cat'] <- levels(f)[1]
T_FOR[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]


t4 <- T_FOR  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill=cat))+
  geom_boxplot() + 
  #geom_dotplot(binaxis = "y",binwidth) +
  #geom_point(alpha=0.2) +
  #geom_jitter(alpha=0.5,mapping=aes(colour=cat),width = 0.1) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized fluorescence intensity",fill="Temperature")+
  scale_fill_scico_d(palette="bilbao",begin = 0,
                     end = 0.9,alpha=0.6)


#PLA
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("T_10d cold","T_10d warm"))
mm <- levels(as.factor(df$T_10d))

C4_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(T_10d,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(T_10d,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(T_10d,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(T_10d,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(T_10d,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(T_10d,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(T_10d,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(T_10d,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(T_10d,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(T_10d,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = T_10d,n=floor(length(mm)/2)) %>% dplyr::select(Comp.5,loc) 


T_PLA <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))


T_PLA [1:nrow(C4_low),'cat'] <- levels(f)[1]
T_PLA[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]



t5 <- T_PLA  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill=cat))+
  geom_boxplot() + 
  #geom_dotplot(binaxis = "y",binwidth) +
  #geom_point(alpha=0.2) +
  #geom_jitter(alpha=0.5,mapping=aes(colour=cat),width = 0.1) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized fluorescence intensity",fill="Temperature")+
  scale_fill_scico_d(palette="bilbao",begin = 0,
                     end = 0.9,alpha=0.6)

#### same for rain
#GRA
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("P_10d dry","P_10d wet"))
mm <- levels(as.factor(df$P_10d))

C4_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(P_10d,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(P_10d,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(P_10d,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(P_10d,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(P_10d,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(P_10d,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(P_10d,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(P_10d,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(P_10d,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(P_10d,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.5,loc) 


P_GRA <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))

P_GRA [1:nrow(C4_low),'cat'] <- levels(f)[1]
P_GRA[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]
##

b1 <- P_GRA %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill = cat,colours=cat))+
  geom_boxplot() + 
  #geom_jitter(alpha=0.2) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized intensity",fill="Precipitation",title="GRA")+
  scale_fill_scico_d(palette="davos",begin = 0.1,
                     end = 1,alpha=0.6)

#GLO
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("P_10d dry","P_10d wet"))
mm <- levels(as.factor(df$P_10d))

C4_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(P_10d,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(P_10d,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(P_10d,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(P_10d,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(P_10d,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(P_10d,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(P_10d,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(P_10d,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(P_10d,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(P_10d,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.5,loc) 


P_GLO <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))

P_GLO [1:nrow(C4_low),'cat'] <- levels(f)[1]
P_GLO[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]


b2 <- P_GLO  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill = cat,colours=cat))+
  geom_boxplot() + 
  #geom_jitter(alpha=0.2) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized intensity",fill="Precipitation",title="GLO")+
  scale_fill_scico_d(palette="davos",begin = 0.1,
                     end = 1,alpha=0.6)

#SKY
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("P_10d dry","P_10d wet"))
mm <- levels(as.factor(df$P_10d))

C4_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(P_10d,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(P_10d,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(P_10d,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(P_10d,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(P_10d,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(P_10d,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(P_10d,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(P_10d,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(P_10d,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(P_10d,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.5,loc) 


P_SKY <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))


P_SKY [1:nrow(C4_low),'cat'] <- levels(f)[1]
P_SKY[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]



b3 <- P_SKY  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill = cat,colours=cat))+
  geom_boxplot() + 
  #geom_jitter(alpha=0.2) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized intensity",fill="Precipitation",title="SKY")+
  scale_fill_scico_d(palette="davos",begin = 0.1,
                     end = 1,alpha=0.6)

#FOR
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("P_10d dry","P_10d wet"))
mm <- levels(as.factor(df$P_10d))

C4_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(P_10d,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(P_10d,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(P_10d,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(P_10d,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(P_10d,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(P_10d,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(P_10d,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(P_10d,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(P_10d,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(P_10d,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.5,loc) 


P_FOR <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))

P_FOR [1:nrow(C4_low),'cat'] <- levels(f)[1]
P_FOR[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]


b4 <- P_FOR  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill = cat,colours=cat))+
  geom_boxplot() + 
  #geom_jitter(alpha=0.2) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized intensity",fill="Precipitation",title="FOR")+
  scale_fill_scico_d(palette="davos",begin = 0.1,
                     end = 1,alpha=0.6)


#PLA
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("P_10d dry","P_10d wet"))
mm <- levels(as.factor(df$P_10d))

C4_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(P_10d,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(P_10d,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(P_10d,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(P_10d,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(P_10d,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = P_10d,n=4) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(P_10d,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(P_10d,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(P_10d,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(P_10d,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(P_10d,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = P_10d,n=4) %>% dplyr::select(Comp.5,loc) 


P_PLA <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))


P_PLA [1:nrow(C4_low),'cat'] <- levels(f)[1]
P_PLA[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]



b5 <- P_PLA  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill = cat,colours=cat))+
  geom_boxplot() + 
  #geom_jitter(alpha=0.2) +
  theme_minimal(base_size = 9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized intensity",fill="Precipitation",title="PLA")+
  scale_fill_scico_d(palette="davos",begin = 0.1,
                     end = 1,alpha=0.6)


#and driprate
#GRA
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("drip low","drip high")) 
mm <- levels(as.factor(df$normdr[df$loc %in% locs]))

C4_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(normdr,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(normdr,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(normdr,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(normdr,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(normdr,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(normdr,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(normdr,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(normdr,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(normdr,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("GRA")) %>%
  dplyr::select(normdr,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.5,loc) 


P_GRA <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))

P_GRA [1:nrow(C4_low),'cat'] <- levels(f)[1]
P_GRA[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]
P_GRA$cat <- as.factor(P_GRA$cat) %>% fct_relevel("drip low","drip high")

##

d1 <- P_GRA %>% gather("param","value",-cat) %>% 
  ggplot(aes(x=param,y=value,fill = cat,colours=cat))+
  geom_boxplot() + 
  #geom_jitter(alpha=0.2) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized intensity",fill="Normalized drip rate",title="GRA")+
  scale_fill_scico_d(palette="tokyo",begin = 0,
                     end = 0.8,alpha=0.6)

#GLO
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("drip low","drip high"))
mm <- levels(as.factor(df$normdr[df$loc %in% locs]))

C4_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(normdr,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(normdr,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(normdr,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(normdr,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(normdr,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(normdr,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(normdr,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(normdr,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(normdr,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("GLO")) %>%
  dplyr::select(normdr,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.5,loc) 


P_GLO <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))

#P_GLO [1:nrow(C4_low),'cat'] <- levels(f)[1]
#P_GLO[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]

P_GLO [1:nrow(C4_low),'cat'] <- levels(f)[1]
P_GLO[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]
P_GLO$cat <- as.factor(P_GLO$cat) %>% fct_relevel("drip low","drip high")


d2 <- P_GLO  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill = cat,colours=cat))+
  geom_boxplot() + 
  #geom_jitter(alpha=0.2) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized intensity",fill="Normalized drip rate",title="GLO")+
  scale_fill_scico_d(palette="tokyo",begin = 0,
                     end = 0.8,alpha=0.6)

#SKY
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("drip low","drip high"))
mm <- levels(as.factor(df$normdr[df$loc %in% locs]))

C4_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(normdr,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(normdr,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(normdr,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(normdr,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(normdr,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(normdr,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(normdr,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(normdr,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(normdr,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("SKY")) %>%
  dplyr::select(normdr,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.5,loc) 


P_SKY <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))


P_SKY [1:nrow(C4_low),'cat'] <- levels(f)[1]
P_SKY[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]
P_SKY$cat <- as.factor(P_SKY$cat) %>% fct_relevel("drip low","drip high")



d3 <- P_SKY  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill = cat,colours=cat))+
  geom_boxplot() + 
  #geom_jitter(alpha=0.2) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized intensity",fill="Normalized drip rate",title="SKY")+
  scale_fill_scico_d(palette="tokyo",begin = 0,
                     end = 0.8,alpha=0.6)

#FOR
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("drip low","drip high"))
mm <- levels(as.factor(df$normdr[df$loc %in% locs]))

C4_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(normdr,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(normdr,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(normdr,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(normdr,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(normdr,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(normdr,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(normdr,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(normdr,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(normdr,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("FOR")) %>%
  dplyr::select(normdr,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.5,loc) 


P_FOR <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))

P_FOR [1:nrow(C4_low),'cat'] <- levels(f)[1]
P_FOR[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]
P_FOR$cat <- as.factor(P_FOR$cat) %>% fct_relevel("drip low","drip high")


d4 <- P_FOR  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill = cat,colours=cat))+
  geom_boxplot() + 
  #geom_jitter(alpha=0.2) +
  theme_minimal(base_size=9) + scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized intensity",fill="Normalized drip rate",title="FOR")+
  scale_fill_scico_d(palette="tokyo",begin = 0,
                     end = 0.8,alpha=0.6)


#PLA
tests <- data.frame(cat=NA,value=NA)
f <- factor(levels=c("drip low","drip high"))
mm <- levels(as.factor(df$normdr[df$loc %in% locs]))

C4_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(normdr,Comp.4,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.4) 

C2_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(normdr,Comp.2,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.2,loc) 

C3_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(normdr,Comp.3,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.3,loc) 

C1_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(normdr,Comp.1,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.1,loc) 

C5_low <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(normdr,Comp.5,loc) %>% group_by(loc) %>% slice_min(order_by = normdr,n=4) %>% dplyr::select(Comp.5,loc) 

C4_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(normdr,Comp.4,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.4,loc) 

C2_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(normdr,Comp.2,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.2,loc) 

C3_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(normdr,Comp.3,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.3,loc) 

C1_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(normdr,Comp.1,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.1,loc) 

C5_high <- df %>% filter(loc %in% c("PLA")) %>%
  dplyr::select(normdr,Comp.5,loc) %>% group_by(loc) %>% slice_max(order_by = normdr,n=4) %>% dplyr::select(Comp.5,loc) 


P_PLA <- data.frame(cat=NA,
                    C1=c(C1_low$Comp.1,C1_high$Comp.1),
                    C2=c(C2_low$Comp.2,C2_high$Comp.2),
                    C3=c(C3_low$Comp.3,C3_high$Comp.3),
                    C4=c(C4_low$Comp.4,C4_high$Comp.4),
                    C5=c(C5_low$Comp.5,C5_high$Comp.5))


P_PLA [1:nrow(C4_low),'cat'] <- levels(f)[1]
P_PLA[(1+nrow(C4_low)):(nrow(C4_low)+nrow(C4_high)),'cat'] <- levels(f)[2]
P_PLA$cat <- as.factor(P_PLA$cat) %>% fct_relevel("drip low","drip high")



d5 <- P_PLA  %>% gather("param","value",-cat) %>%
  ggplot(aes(x=param,y=value,fill = cat,colours=cat))+
  geom_boxplot() + 
  #geom_jitter(alpha=0.2) +
  theme_minimal(base_size = 9) + #scale_y_sqrt() +
  labs(x="PARAFAC",y="normalized intensity",fill="Normalized drip rate",title="PLA")+
  scale_fill_scico_d(palette="tokyo",begin = 0,
                     end = 0.8,alpha=0.6)




#library(patchwork)
#wrap_plots(list(b4,b2,b1,b5,b3),guides="collect")


#library(gridExtra)


m<-wrap_plots(list(
  b4+rremove("xlab")+ rremove("ylab"),b2 + rremove("ylab")+rremove("xlab"),b1+ rremove("ylab")+rremove("xlab"),b5+ rremove("ylab")+rremove("xlab"),
  b3+ rremove("ylab")+rremove("xlab"),
  d4+rremove("xlab")+ rremove("ylab"),d2 + rremove("ylab")+rremove("xlab"),d1+ rremove("ylab")+rremove("xlab"),d5+ rremove("ylab")+rremove("xlab"),
  d3+ rremove("ylab")+rremove("xlab"),
  t4+ rremove("ylab")+rremove("xlab"),t2 + rremove("ylab")+rremove("xlab"),t1+ rremove("ylab"),
                t5+ rremove("ylab")+rremove("xlab"),t3+ rremove("ylab")+rremove("xlab")),nrow=3,guides="collect")

ylabi <- ggplot(data.frame(l ="normalized fluorescence intensity", x = 1, y = 1)) +
  geom_text(aes(x, y, label = l), angle = 90) + 
  theme_void() +
  coord_cartesian(clip = "off")


ylabi + m + plot_layout(widths=c(1,25))
#ggsave(filename="Endres_Fig8.tiff",width=200*1.3,height=100*1.3,units='mm',dpi=600)
#A4: 297 mm x 210 mm




```

Figure 9. Relationship of climate conditions versus fluorescence intensity of each PARAFAC component for the five locations FOR GLO, GRA, PLA, and SKY. In the 830
upper row, data were split in dry or wet conditions based on the total precipitation in the 10 days before sampling. In the middle row, data were split in a high and a
831 low drip rate group, based on the normalized drip rate (previously reported in Kost et al., 2023). The bottom row shows an analogous comparison of warm versus
832 cold average surface temperatures to fluorescence. The sample size of each group (n = 4) was limited by the total length of the time series of location FOR. The
833 boxplots show the median, first, and third quartiles; the attached whiskers extend from the hinges to the extreme values, no farther than 1.5 × inter-quartile range;
and data outside of whiskers are plotted as single black dots.

## Figure 10

```{r Fig10,echo=FALSE}
#load data
df <- readRDS(file="Data/LaVallina_Fluo_pub.rds")

# Plot
plotter <- df %>% gather("param","value",-c(loc,Sr_ppm,Cu_ppm,drip_d13C_DIC)) %>%
  filter(param %in% c("Comp.1","Comp.3","C3_C1C5ratio","C2andC4")) %>%
  gather("te","te_value",-c(loc,param,value)) %>%
  mutate(loc = fct_relevel(loc, 
                           "FOR","SNO", "GLO","GRA","PLA","SKY","MUS"),
         param=fct_relevel(param,"Comp.1","Comp.3","C3_C5C1ratio","C2andC4")) 

plotter$param <- factor(plotter$param,levels = c("Comp.1","Comp.3","C3_C5C1ratio","C2andC4"),
                        labels = c("C1 (\"humic-like\")","C3 (\"fossil-like\")","C3/(C5+C1)", "C2+C4 (\"protein-like\")"))

plotter$te <- factor(plotter$te,levels = c("drip_d13C_DIC","Sr_ppm","Cu_ppm"),
                     labels = c( "d13C drip water","Sr (ppm)","Cu (ppm)"))

plotter %>%
  ggplot(aes(x=te_value,y=as.numeric(value))) + geom_point(mapping=aes(color=loc),size=0.8) +
  facet_wrap(te ~ param, scales = "free",ncol=4)+theme_classic(base_size=8) +
  scale_color_scico_d(palette="romaO",begin = 0.1,
                      end = 0.9) +
  xlab("Drip water chemistry value") + ylab("Fluorescence intensity value") + labs(color="drip site")

#ggsave(filename="Endres_Fig10.tiff",width=190,height=140,units='mm',dpi=600)
```

Figure 10. Graphical representation of relationships between fluorescence (C1, C3, C3/(C5+C1), C2+C4) and selected drip water geochemistry parameters. Drip water chemistry data (δ13CDIC, Sr concentration, Cu concentration) is re-used from the study Kost et. al, 2023. For numerical values of Spearman rank correlation coefficients, see Table 3. (A) Comparison of fluorescence with the δ13C of DIC in drip water, which is an indicator of soil and epikarst CO2 and respiration rates. (B) Comparison of fluorescence with drip water Sr concentration, which is an indicator of the extent of dissolution of karst bedrock. (C) Comparison of fluorescence with the total drip water Cu concentration as an indicator for the presence of colloidal organic complexes.

## Supplement: Labels of variables
```{r,echo=FALSE}
df <- readRDS(file="Data/LaVallina_Fluo_pub.rds") 
odd <- function(x) x%%2 != 0
even <- function(x) x%%2 == 0
Hmisc::label(df)

```


